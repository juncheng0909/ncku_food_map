<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>æˆå¤§äººã®ç¾é£Ÿåœ°åœ–</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h1>æˆå¤§äººã®ç¾é£Ÿæ¨è–¦</h1>
  <div class="sort-container">
    <span>æ’åºæ–¹å¼ï¼š</span>
    <button id="sort-by-likes-btn" class="sort-btn active">ğŸ‘ ä¾æ¨è–¦æ•¸</button>
    <button id="sort-by-default-btn" class="sort-btn">ğŸ  é è¨­æ’åº</button>
  </div>
  <!-- é¤å»³åˆ—è¡¨ (ç”¨JavaScriptå‹•æ…‹ç”Ÿæˆæ–¼æ­¤) -->
  <div id="restaurant-list"></div>

  <!-- å³é‚Šçš„å·¥å…·åˆ— -->
  <div class="toolbar">
    <button id="random-pick-btn">ğŸ¤”æ™šé¤åƒä»€éº¼?</button>
    <button id="search-btn">ğŸ” æœå°‹é¤å»³</button>
    <button id="add-btn">â• æ–°å¢é¤å»³</button>
    <button id="dev-btn">ğŸ‘¨â€ğŸ’» é–‹ç™¼äººå“¡</button>
  </div>

  <!-- æ–°å¢é¤å»³çš„å½ˆå‡ºè¦–çª—ï¼Œé è¨­ç‚ºéš±è— -->
  <div id="add-restaurant-modal" class="modal hidden">
    <div class="modal-content">
      <span class="close-btn">Ã—</span>
      <h2>æ–°å¢ç¾é£Ÿæ¨è–¦</h2>
      <form id="add-restaurant-form">
        <input type="text" name="name" placeholder="é¤å»³åç¨±" required>
        <input type="text" name="address" placeholder="åœ°å€" required>
        <input type="text" name="hours" placeholder="ç‡Ÿæ¥­æ™‚é–“" required>
        <input type="text" name="recommended" placeholder="æ¨è–¦é¤é»" required>
        <input type="url" name="mapLink" placeholder="Google Maps é€£çµ" required>
        <button type="submit">ç¢ºèªæ–°å¢</button>
      </form>
    </div>
  </div>

  <!-- è¼‰å…¥ Firebase CDN -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

  <!-- JavaScript -->
  <script>
    // åˆå§‹åŒ– Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyA-8tDGNQ1j868OFNLHTBrQ2uh4IaI0F40",
      authDomain: "ncku-food-map.firebaseapp.com",
      databaseURL: "https://ncku-food-map-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "ncku-food-map",
      storageBucket: "ncku-food-map.firebasestorage.app",
      messagingSenderId: "339570174998",
      appId: "1:339570174998:web:9876041b23d74fdf36d937"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const restaurantsRef = db.ref('restaurants');
    const restaurantList = document.getElementById('restaurant-list');

    // æ–°å¢å…¨åŸŸè®Šæ•¸ä¾†å„²å­˜è³‡æ–™å’Œç•¶å‰æ’åºç‹€æ…‹
    let allRestaurantData = [];
    let currentSortMethod = 'likes'; // é è¨­ä¾æ¨è–¦æ•¸æ’åº

    // å¾ Firebase è®€å–è³‡æ–™
    restaurantsRef.on('value', (snapshot) => {
      const restaurants = snapshot.val();
      if (restaurants) {
        // å°‡ç‰©ä»¶è½‰ç‚ºé™£åˆ—ä¸¦å­˜åˆ°å…¨åŸŸè®Šæ•¸
        allRestaurantData = Object.entries(restaurants);
        // å‘¼å«æ–°çš„æ’åºèˆ‡æ¸²æŸ“å‡½å¼
        sortAndRender();
      } else {
        // æ²’æœ‰è³‡æ–™çš„æƒ…æ³
        allRestaurantData = [];
        restaurantList.innerHTML = '<h2>ç›®å‰é‚„æ²’æœ‰ä»»ä½•é¤å»³è³‡æ–™å–”ï¼</h2>';
      }
    });

    // æ–°å¢ï¼šç”¨ä¾†æ’åºå’Œè§¸ç™¼æ¸²æŸ“çš„å‡½å¼(rendering)
    function sortAndRender() {
      // è¤‡è£½ä¸€ä»½é™£åˆ—ä¾†æ’åºï¼Œæ‰ä¸æœƒå‹•åˆ°åŸå§‹è³‡æ–™é †åº
      let sortedData = [...allRestaurantData];

      if (currentSortMethod === 'likes') {
        // ä¾æ¨è–¦æ•¸ (likes) é™å†ªæ’åº
        sortedData.sort(([, a], [, b]) => (b.likes || 0) - (a.likes || 0));
      }
      // å¦‚æœ currentSortMethod æ˜¯ 'default'ï¼Œå‰‡ä¸é€²è¡Œ sortï¼Œç›´æ¥ä½¿ç”¨åŸå§‹é †åº
      
      // æœ€å¾Œï¼Œå‘¼å«æ¸²æŸ“å‡½å¼(rendering)
      renderList(sortedData);
    }
    
    // æ–°å¢ï¼šå°ˆé–€æ¸²æŸ“åˆ—è¡¨çš„å‡½å¼ (å°‡åŸæœ¬çš„ forEach é‚è¼¯æ¬ç§»åˆ°é€™è£¡)
    function renderList(restaurantArray) {
        restaurantList.innerHTML = ''; // æ¸…ç©ºåˆ—è¡¨
        restaurantArray.forEach(([id, data]) => {
            createRestaurantCard(id, data);
        });
    }

    // å‰µå»ºå–®ä¸€é¤å»³å¡ç‰‡çš„å‡½å¼
    function createRestaurantCard(id, data) {
      const likes = data.likes || 0;
      const dislikes = data.dislikes || 0;

      const restaurantDiv = document.createElement('div');
      restaurantDiv.className = 'restaurant';
      restaurantDiv.dataset.id = id;
      // å¦‚æœæ²’æœ‰ nameï¼Œçµ¦é è¨­å€¼é¿å…å‡ºéŒ¯
      restaurantDiv.dataset.name = (data.name || '').toLowerCase();

      restaurantDiv.innerHTML = `
        <h2>${data.name || 'åº—åæœªæä¾›'}</h2>
        <p>ğŸ“ åœ°å€ï¼š${data.address || 'åœ°å€æœªæä¾›'}</p>
        <p>ğŸ•’ ç‡Ÿæ¥­æ™‚é–“ï¼š${data.hours || 'æ™‚é–“æœªæä¾›'}</p>
        <p>ğŸŒŸ æ¨è–¦é¤é»ï¼š${data.recommended || 'é¤é»æœªæä¾›'}</p>
        <a href="${data.mapLink || '#'}" target="_blank">æŸ¥çœ‹åœ°åœ–</a>
        <button class="like-btn">ğŸ‘ æ¨ <span class="like-count">${likes}</span></button>
        <button class="dislike-btn">ğŸ‘ ä¸æ¨ <span class="dislike-count">${dislikes}</span></button>
      `;
      
      restaurantList.appendChild(restaurantDiv);

      const likeBtn = restaurantDiv.querySelector('.like-btn');
      const dislikeBtn = restaurantDiv.querySelector('.dislike-btn');

      likeBtn.addEventListener('click', () => {
        const newLikes = likes + 1;
        restaurantsRef.child(id).update({ likes: newLikes });
      });

      dislikeBtn.addEventListener('click', () => {
        const newDislikes = dislikes + 1;
        restaurantsRef.child(id).update({ dislikes: newDislikes });
      });
    }
    
    // æ–°å¢ï¼šæ’åºæŒ‰éˆ•
    const sortByLikesBtn = document.getElementById('sort-by-likes-btn');
    const sortByDefaultBtn = document.getElementById('sort-by-default-btn');

    sortByLikesBtn.addEventListener('click', () => {
      currentSortMethod = 'likes';
      sortByLikesBtn.classList.add('active');
      sortByDefaultBtn.classList.remove('active');
      sortAndRender(); // é‡æ–°æ’åºå’Œæ¸²æŸ“
    });

    sortByDefaultBtn.addEventListener('click', () => {
      currentSortMethod = 'default';
      sortByDefaultBtn.classList.add('active');
      sortByLikesBtn.classList.remove('active');
      sortAndRender(); // é‡æ–°æ’åºå’Œæ¸²æŸ“
    });


    // å·¥å…·åˆ—åŠŸèƒ½
    const addBtn = document.getElementById('add-btn');
    const searchBtn = document.getElementById('search-btn');
    const devBtn = document.getElementById('dev-btn');
    const modal = document.getElementById('add-restaurant-modal');
    const closeModalBtn = document.querySelector('.close-btn');
    const addForm = document.getElementById('add-restaurant-form');
    // "æ–°å¢é¤å»³" æŒ‰éˆ•
    addBtn.addEventListener('click', () => {
      modal.classList.remove('hidden');
    });

    // é—œé–‰å½ˆå‡ºè¦–çª—
    closeModalBtn.addEventListener('click', () => {
      modal.classList.add('hidden');
    });
    window.addEventListener('click', (event) => {
      if (event.target === modal) {
        modal.classList.add('hidden');
      }
    });

    // è™•ç†è¡¨å–®æäº¤
    addForm.addEventListener('submit', (event) => {
      event.preventDefault();
      const newRestaurantData = {
        name: addForm.elements.name.value,
        address: addForm.elements.address.value,
        hours: addForm.elements.hours.value,
        recommended: addForm.elements.recommended.value,
        mapLink: addForm.elements.mapLink.value,
        likes: 0,
        dislikes: 0
      };
      restaurantsRef.push(newRestaurantData)
        .then(() => {
          alert('é¤å»³æ–°å¢æˆåŠŸï¼');
          addForm.reset();
          modal.classList.add('hidden');
        })
        .catch((error) => {
          console.error("æ–°å¢å¤±æ•—:", error);
          alert('æ–°å¢å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
        });
    });
    
    // "æœå°‹é¤å»³" æŒ‰éˆ•
    searchBtn.addEventListener('click', () => {
        const keyword = prompt('è«‹è¼¸å…¥é¤å»³åç¨±é—œéµå­—ï¼š');
        if (keyword === null) return;
        const allRestaurants = document.querySelectorAll('.restaurant');
        allRestaurants.forEach(card => {
            const restaurantName = card.dataset.name;
            if(restaurantName.includes(keyword.toLowerCase())) {
                card.style.display = 'block';
            } else {
                card.style.display = 'none';
            }
        });
    });

    // "é–‹ç™¼äººå“¡" æŒ‰éˆ•
    devBtn.addEventListener('click', () => {
        alert('Developed by JunCheng 909\nIns : __jc909');
    });

    // "éš¨æ©Ÿé¸ä¸€å®¶" åŠŸèƒ½
    const randomPickBtn = document.getElementById('random-pick-btn');
    randomPickBtn.addEventListener('click', () => {
        const allRestaurants = document.querySelectorAll('div.restaurant:not([style*="display: none"])');
        if (allRestaurants.length === 0) {
            alert('ç›®å‰æ²’æœ‰é¤å»³å¯ä»¥é¸æ“‡å–”ï¼');
            return;
        }
        allRestaurants.forEach(card => card.classList.remove('highlighted'));
        const randomIndex = Math.floor(Math.random() * allRestaurants.length);
        const pickedRestaurant = allRestaurants[randomIndex];
        pickedRestaurant.classList.add('highlighted');
        pickedRestaurant.scrollIntoView({ 
            behavior: 'smooth',
            block: 'center'
        });
    });
</script>
</body>
</html>