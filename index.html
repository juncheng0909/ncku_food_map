<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>æˆå¤§äººã®ç¾é£Ÿåœ°åœ–</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h1>æˆå¤§äººã®ç¾é£Ÿæ¨è–¦</h1>

  <!-- é¤å»³åˆ—è¡¨å°‡æœƒç”± JavaScript å‹•æ…‹ç”Ÿæˆæ–¼æ­¤ -->
  <div id="restaurant-list"></div>

  <!-- å³å´å·¥å…·åˆ— -->
  <div class="toolbar">
    <button id="search-btn">ğŸ” æœå°‹é¤å»³</button>
    <button id="add-btn">â• æ–°å¢é¤å»³</button>
    <button id="dev-btn">ğŸ‘¨â€ğŸ’» é–‹ç™¼äººå“¡</button>
  </div>

  <!-- æ–°å¢é¤å»³çš„å½ˆå‡ºè¦–çª— (Modal)ï¼Œé è¨­ç‚ºéš±è— -->
  <div id="add-restaurant-modal" class="modal hidden">
    <div class="modal-content">
      <span class="close-btn">Ã—</span>
      <h2>æ–°å¢ç¾é£Ÿæ¨è–¦</h2>
      <form id="add-restaurant-form">
        <input type="text" name="name" placeholder="é¤å»³åç¨±" required>
        <input type="text" name="address" placeholder="åœ°å€" required>
        <input type="text" name="hours" placeholder="ç‡Ÿæ¥­æ™‚é–“" required>
        <input type="text" name="recommended" placeholder="æ¨è–¦é¤é»" required>
        <input type="url" name="mapLink" placeholder="Google Maps é€£çµ" required>
        <button type="submit">ç¢ºèªæ–°å¢</button>
      </form>
    </div>
  </div>

  <!-- è¼‰å…¥ Firebase CDN -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

  <!-- ä½ çš„ JavaScript ç¨‹å¼ç¢¼ -->
  <script>
    // 1. åˆå§‹åŒ– Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyA-8tDGNQ1j868OFNLHTBrQ2uh4IaI0F40", // è«‹ä½¿ç”¨ä½ è‡ªå·±çš„é‡‘é‘°
      authDomain: "ncku-food-map.firebaseapp.com",
      databaseURL: "https://ncku-food-map-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "ncku-food-map",
      storageBucket: "ncku-food-map.firebasestorage.app",
      messagingSenderId: "339570174998",
      appId: "1:339570174998:web:9876041b23d74fdf36d937"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const restaurantsRef = db.ref('restaurants');

    const restaurantList = document.getElementById('restaurant-list');

    // 2. å¾ Firebase è®€å–è³‡æ–™ä¸¦å‹•æ…‹æ¸²æŸ“ç•«é¢
    // ä½¿ç”¨ .on() è€Œä¸æ˜¯ .once()ï¼Œé€™æ¨£ç•¶è³‡æ–™åº«æœ‰ä»»ä½•è®Šå‹•ï¼ˆä¾‹å¦‚æ–°å¢é¤å»³ï¼‰ï¼Œç•«é¢æœƒè‡ªå‹•æ›´æ–°
    restaurantsRef.on('value', (snapshot) => {
      restaurantList.innerHTML = ''; // æ¯æ¬¡æ›´æ–°å‰å…ˆæ¸…ç©ºåˆ—è¡¨
      const restaurants = snapshot.val();
      if (restaurants) {
        Object.entries(restaurants).forEach(([id, data]) => {
          createRestaurantCard(id, data);
        });
      }
    });

    // 3. å‰µå»ºå–®ä¸€é¤å»³å¡ç‰‡çš„å‡½å¼
    function createRestaurantCard(id, data) {
      const likes = data.likes || 0;
      const dislikes = data.dislikes || 0;

      const restaurantDiv = document.createElement('div');
      restaurantDiv.className = 'restaurant';
      restaurantDiv.dataset.id = id;
      restaurantDiv.dataset.name = data.name.toLowerCase(); // ç‚ºäº†æœå°‹åŠŸèƒ½

      restaurantDiv.innerHTML = `
        <h2>${data.name}</h2>
        <p>ğŸ“ åœ°å€ï¼š${data.address}</p>
        <p>ğŸ•’ ç‡Ÿæ¥­æ™‚é–“ï¼š${data.hours}</p>
        <p>ğŸŒŸ æ¨è–¦é¤é»ï¼š${data.recommended}</p>
        <a href="${data.mapLink}" target="_blank">æŸ¥çœ‹åœ°åœ–</a>
        <button class="like-btn">ğŸ‘ æ¨ <span class="like-count">${likes}</span></button>
        <button class="dislike-btn">ğŸ‘ ä¸æ¨ <span class="dislike-count">${dislikes}</span></button>
      `;
      
      restaurantList.appendChild(restaurantDiv);

      // ç¶å®šäº‹ä»¶ç›£è½å™¨ (å¿…é ˆåœ¨å…ƒç´ å‰µå»ºå¾Œç¶å®š)
      const likeBtn = restaurantDiv.querySelector('.like-btn');
      const dislikeBtn = restaurantDiv.querySelector('.dislike-btn');

      likeBtn.addEventListener('click', () => {
        const newLikes = likes + 1;
        restaurantsRef.child(id).update({ likes: newLikes });
      });

      dislikeBtn.addEventListener('click', () => {
        const newDislikes = dislikes + 1;
        restaurantsRef.child(id).update({ dislikes: newDislikes });
      });
    }

    // 4. å·¥å…·åˆ—åŠŸèƒ½
    const addBtn = document.getElementById('add-btn');
    const searchBtn = document.getElementById('search-btn');
    const devBtn = document.getElementById('dev-btn');
    const modal = document.getElementById('add-restaurant-modal');
    const closeModalBtn = document.querySelector('.close-btn');
    const addForm = document.getElementById('add-restaurant-form');

    // 4.1 "æ–°å¢é¤å»³" æŒ‰éˆ•
    addBtn.addEventListener('click', () => {
      modal.classList.remove('hidden');
    });

    // 4.2 é—œé–‰å½ˆå‡ºè¦–çª—
    closeModalBtn.addEventListener('click', () => {
      modal.classList.add('hidden');
    });
    window.addEventListener('click', (event) => {
      if (event.target === modal) {
        modal.classList.add('hidden');
      }
    });

    // 4.3 è™•ç†è¡¨å–®æäº¤
    addForm.addEventListener('submit', (event) => {
      event.preventDefault(); // é˜²æ­¢é é¢é‡æ–°è¼‰å…¥
      
      const newRestaurantData = {
        name: addForm.elements.name.value,
        address: addForm.elements.address.value,
        hours: addForm.elements.hours.value,
        recommended: addForm.elements.recommended.value,
        mapLink: addForm.elements.mapLink.value,
        likes: 0,
        dislikes: 0
      };

      // ä½¿ç”¨ push() æœƒè‡ªå‹•ç”Ÿæˆä¸€å€‹å”¯ä¸€çš„ keyï¼Œä¸¦å°‡è³‡æ–™å¯«å…¥
      restaurantsRef.push(newRestaurantData)
        .then(() => {
          alert('é¤å»³æ–°å¢æˆåŠŸï¼');
          addForm.reset(); // æ¸…ç©ºè¡¨å–®
          modal.classList.add('hidden'); // é—œé–‰è¦–çª—
        })
        .catch((error) => {
          console.error("æ–°å¢å¤±æ•—:", error);
          alert('æ–°å¢å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
        });
    });
    
    // 4.4 "æœå°‹é¤å»³" æŒ‰éˆ•
    searchBtn.addEventListener('click', () => {
        const keyword = prompt('è«‹è¼¸å…¥é¤å»³åç¨±é—œéµå­—ï¼š');
        if (keyword === null) return; // ä½¿ç”¨è€…æŒ‰ä¸‹å–æ¶ˆ

        const allRestaurants = document.querySelectorAll('.restaurant');
        allRestaurants.forEach(card => {
            // dataset.name æ˜¯æˆ‘å€‘åœ¨ä¸Šé¢ createRestaurantCard æ™‚å­˜å…¥çš„
            const restaurantName = card.dataset.name;
            if(restaurantName.includes(keyword.toLowerCase())) {
                card.style.display = 'block'; // é¡¯ç¤ºç¬¦åˆçš„
            } else {
                card.style.display = 'none'; // éš±è—ä¸ç¬¦åˆçš„
            }
        });
    });

    // 4.5 "é–‹ç™¼äººå“¡" æŒ‰éˆ•
    devBtn.addEventListener('click', () => {
        alert('æ­¤ç¶²ç«™è˜‡å°ç™½é–‹ç™¼ï¼');
    });
  </script>
</body>
</html>